<div class="pc-container">
  <div class="pcoded-content pb" style="padding-bottom:90px;">
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="page-header-title">
              <h5 class="m-b-10"> Report Authorization </h5>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-5">
      <form [formGroup]="form" (ngSubmit)="onSubmit()" *ngIf="userLevel">
        <div class="card">
          <div class="card-body">
            <div id="searchByFilingNumber" class="row searchbypanel">

              <div class="col-md-7 col-12 mb-10 d-flex justify-content-between">
                <label class="form-label">Search by Name / Belt No. / Mobile No.<sup class="text-danger">*</sup></label>
                <p-autoComplete formControlName="Name" [suggestions]="suggestions" (completeMethod)="getBrands($event)"
                  (onSelect)="loadModuleAssignData($event)" tabindex="1"
                  [placeholder]="'Search by Name / Belt No. / Mobile No'" field="FullName" class="width-adjut">
                </p-autoComplete>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-3" *ngIf="suggestionsUserDetails.length">
          <div class="card-body">

            <div *ngFor="let item of suggestionsUserDetails" class="mb-3 border rounded p-3">
              <div class="row mb-2">
                <div class="col-md-12">
                  <h4>Selected User Details : {{ Name }}</h4>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4"><strong>Name:</strong> {{ item.FullName }}</div>
                <div class="col-md-4"><strong>Mobile:</strong> {{ item.MOBILE_1 }}</div>
                <div class="col-md-4"><strong>Belt No.:</strong> {{ item.BELTNO }}</div>
                <div class="col-md-4"><strong>State:</strong> {{ item.STATE }}</div>
                <div class="col-md-4"><strong>District:</strong> {{ item.DISTRICT }}</div>
                <div class="col-md-4"><strong>Police Station:</strong> {{ item.PS }}</div>
                <div class="col-md-4"><strong>Role:</strong> {{ item.ROLE }}</div>
                <div class="col-md-4"><strong>PS staff code:</strong> {{ item.PS_STAFF_CD }}</div>
                <div class="col-md-4"><strong>Person code:</strong> {{ item.PERSON_CODE }}</div>
              </div>
            </div>
          </div>
        </div>


        <div class="card" *ngIf="suggestions && suggestions.length > 0">
          <div class="card-body">
            <div id="searchByFilingNumber" class="row searchbypanel">

              <!-- Radio Buttons -->
              <div class="row mb-3" *ngIf="userLevel">
                <div class="col-md-12">
                  <h4>Role type</h4><br />

                  <!-- STATE -->
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" value="state" formControlName="searchType"
                      [attr.disabled]="userLevel === 'district' || userLevel === 'police' ? true : null" />
                    <label class="form-check-label">State</label>
                  </div>

                  <!-- Range -->
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" value="range" formControlName="searchType"
                      [attr.disabled]="userLevel === 'police' ? true : null" />
                    <label class="form-check-label">Range</label>
                  </div>
                  <!-- DISTRICT -->
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" value="district" formControlName="searchType"
                      [attr.disabled]="userLevel === 'police' ? true : null" />
                    <label class="form-check-label">District</label>
                  </div>

                  <!-- Sub Division -->
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" value="subdivision" formControlName="searchType"
                      [attr.disabled]="userLevel === 'police' ? true : null" />
                    <label class="form-check-label">Sub Division</label>
                  </div>
                  <!-- POLICE -->
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" value="police" formControlName="searchType"
                      [attr.disabled]="null" />
                    <label class="form-check-label">Police Station</label>
                  </div>
                </div>
              </div>


              <!-- State Dropdown -->
              <div class="col-md-3 col-12 mb-2" *ngIf="true">
                <label class="form-label">State <sup class="text-danger">*</sup></label>
                <select class="form-select" formControlName="state">
                  <option value="" disabled>Select State</option>
                  <option *ngFor="let state of states" [value]="state.StateCode">
                    {{ state.stateName }}
                  </option>
                </select>
                <div *ngIf="isSubmitted && f['state'].errors" class="invalid-feedback d-block">
                  <div *ngIf="f['state'].errors['required']">State is required</div>
                </div>
              </div>
              <!-- Range -->
              <div class="col-md-3 col-12 mb-3" *ngIf="form.get('searchType')?.value === 'range'">
                <label class="form-label">Range Name</label>
                <sup class="text-danger top-0">*</sup>
                <select formControlName="Range" tabindex="1" class="form-control form-select">
                  <option value="">Select</option>
                  <option *ngFor="let range of Ranges" [value]="range.value">
                    {{ range.text }}
                  </option>
                </select>
              </div>

              <!-- Range Name -->
              <div class="col-md-3 col-12 mb-3" *ngIf="form.get('searchType')?.value === 'subdivision'">
                <label class="form-label">Range Name <sup class="text-danger">*</sup></label>
                <select formControlName="Range" class="form-control form-select" tabindex="1"
                  (change)="loadDistricts($event)"
                  [ngClass]="{ 'is-invalid': isSubmitted && form.get('Range')?.invalid }">
                  <option value="">Select</option>
                  <option *ngFor="let range of Ranges" [value]="range.value">
                    {{ range.text }}
                  </option>
                </select>
                <div *ngIf="isSubmitted && form.get('Range')?.errors?.['required']" class="invalid-feedback d-block">
                  Range is required
                </div>
              </div>

              <!-- District Name -->
              <div class="col-md-3 col-12 mb-3" *ngIf="form.get('searchType')?.value === 'subdivision'">
                <label class="form-label">District Name <sup class="text-danger">*</sup></label>
                <select formControlName="District" class="form-control form-select" tabindex="2"  (change)="BindSubDivision($event)"
                  [ngClass]="{ 'is-invalid': isSubmitted && form.get('District')?.invalid }">
                  <option value="">Select District</option>
                  <option *ngFor="let district of Districts" [value]="district.value">
                    {{ district.text }}
                  </option>
                </select>
                <div *ngIf="isSubmitted && form.get('District')?.errors?.['required']" class="invalid-feedback d-block">
                  District is required
                </div>
              </div>
              <!-- Sub Division -->
              <div class="col-md-3 col-12 mb-3" *ngIf="form.get('searchType')?.value === 'subdivision'">
                <label class="form-label">Sub Division</label>
                <sup class="text-danger top-0">*</sup>
                <select formControlName="SubDivision" tabindex="1" class="form-control form-select">
                  <option value="">Select</option>
                  <option *ngFor="let range of Subdivision" [value]="range.value">
                    {{ range.text }}
                  </option>
                </select>
              </div>
              <!-- District Dropdown -->
              <div class="col-md-3 col-12 mb-2"
                *ngIf="form.get('searchType')?.value === 'district' || form.get('searchType')?.value === 'police'">
                <label class="form-label">District Name</label>
                <ng-multiselect-dropdown #multiSelect [settings]="settings" [data]="ListDistict"
                  formControlName="districtCodes" [placeholder]="'Select District'" tabindex="1"
                  (onDropDownClose)="onDistrictDropdownChange($event)">
                </ng-multiselect-dropdown>
                <div *ngIf="isSubmitted && f['districtCodes'].errors" class="invalid-feedback d-block">
                  <div *ngIf="f['districtCodes'].errors['required']">District is required</div>
                </div>
              </div>

              <!-- Police Dropdown -->
              <div class="col-md-3 col-12 mb-2" *ngIf="form.get('searchType')?.value === 'police'">
                <label class="form-label">Police Station</label>
                <ng-multiselect-dropdown #multiSelect [settings]="settings" [data]="policestations"
                  formControlName="PsCodes" [placeholder]="'Police Station'" tabindex="2">
                </ng-multiselect-dropdown>
                <div *ngIf="isSubmitted && f['PsCodes'].errors" class="invalid-feedback d-block">
                  <div *ngIf="f['PsCodes'].errors['required']">Police Station is required</div>
                </div>
              </div>
              <div class="col-md-3 col-12 mb-2">
                <label class="form-label">User Type <sup class="text-danger">*</sup></label>
                <select class="form-select" formControlName="userType">
                  <option value="" disabled>Select user type</option>
                  <option *ngFor="let type of UserType" [value]="type.value">
                    {{ type.text }}
                  </option>
                </select>
                <div *ngIf="isSubmitted && f['userType']?.errors" class="invalid-feedback d-block">
                  <div *ngIf="f['userType']?.errors?.['required']">User Type is required</div>
                </div>
              </div>

              <div class="col-12 mb-3 pt-4 mt-1" style="text-align: right;">
                <button type="submit" class="btn btn-success text-white py-1" tabindex="6">Submit</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" *ngIf="moduleAssignList && moduleAssignList.length > 0">
          <div class="card-body">
            <div id="searchByFilingNumber" class="row searchbypanel">
              <div class="row mb-3">
                <div class="col-md-12">
                  <h4>Selected user : {{ Name }}</h4><br />
                </div>
              </div>
              <p-table [value]="moduleAssignList" selectionMode="multiple" [(selection)]="selectedRows" dataKey="PS_CD"
                [paginator]="true" [rows]="10" [rowHover]="true">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Sr. No</th>
                    <th *ngFor="let col of moduleAssignColumns">{{ col.header }}</th>
                    <th class="form-label">Assign Module</th>
                    <th style="width: 3em"> Block
                      <p-tableHeaderCheckbox [checked]="isAllSelected()" (onChange)="onHeaderCheckboxToggle($event)"
                        [disabled]="hasOnlyBlockedRows()">
                      </p-tableHeaderCheckbox>
                    </th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
                  <tr [pSelectableRow]="row.BLOCK ? null : row" [ngClass]="{ 'blocked-row': row.BLOCK }">
                    <td>{{ rowIndex + 1 }}</td>
                    <td *ngFor="let col of moduleAssignColumns">
                      {{ row[col.field] }}
                    </td>
                    <td>
                      <input type="checkbox" [value]="row" [disabled]="row.BLOCK"
                        (change)="onModuleCheckboxChange(row, $event)" style="width: 3em" />
                    </td>
                    <td>
                      <p-tableCheckbox [value]="row" [disabled]="row.BLOCK" [binary]="true" [checked]="row.BLOCK"
                        [ngModel]="row.BLOCK || isRowSelected(row)" (onChange)="onModuleCheckboxChange(row, $event)">
                      </p-tableCheckbox>
                    </td>
                  </tr>
                </ng-template>
              </p-table>

              <div class="col-md-3 col-12 mb-2" *ngIf="isModuleChecked">
                <label class="form-label">Select Module:<sup class="text-danger">*</sup></label>
                <ng-multiselect-dropdown #multiSelect [settings]="settings" [data]="ListReport"
                  formControlName="ReportName" [placeholder]="'Select Report'" tabindex="3">
                </ng-multiselect-dropdown>
              </div>

              <div class="mt-3 text-end">
                <button type="button" class="btn new-bg-blue text-white me-4"
                  [disabled]="!isModuleChecked || !form.get('ReportName')?.value" (click)="onAssignModule()">
                  Assign Module
                </button>
                <button type="button" class="btn text-whitenew-bg-red"
                  [disabled]="!selectedRows || selectedRows.length === 0" (click)="submitSelectedModules()">
                  Block Rows
                </button>
              </div>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>