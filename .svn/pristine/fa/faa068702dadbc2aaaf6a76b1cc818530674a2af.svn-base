import { Component } from '@angular/core';
import { AbstractControl, FormBuilder, FormControl, FormGroup, Validators } from '@angular/forms';
import { AuthService } from '../services/auth.service';
import { UtilityService } from '../services/utility.service';
import { ActsearchService } from '../services/actsearch.service';
import { ReportAuthorizationService } from '../services/report-authorization.service';
import Swal from 'sweetalert2';
import { forkJoin } from 'rxjs';
export interface DropdownOption {
  value: number;
  text: string;
}



export interface ModuleAssignUpdateRequestModel {
  StateCode: number;
  DistrictCode: number;
  PsCode: number;
  block: boolean;
  ReportName: string[];
  MobileNumber: string;
}

@Component({
  selector: 'app-user-registrationfor-report-authencation',
  templateUrl: './user-registrationfor-report-authencation.component.html',
  styleUrls: ['./user-registrationfor-report-authencation.component.css']
})
export class UserRegistrationforReportAuthencationComponent {

  isLoaded = false;
  isSubmitted = false;
  firdata: any = [];
  form!: FormGroup;
  fg!: FormGroup;
  nameQuery: string = '';
  nameSuggestions: any[] = [];
  policestations: any[] = [];
  ListDistict: any[] = [];
  errorMessage: string = '';
  settings = {};
  selectedPerson: any;
  states: any[] = [];
  isOtpButton: boolean = false;
  selectedStateCode: number = 0;
  selectedType: 'state' | 'district' | 'police' = 'state';
  suggestions: string[] = []
  moduleAssignList: any[] = [];
  Name: string = '';
  selectedRows: any[] = [];
  isModuleChecked = false;
  moduleAssignColumns: any[] = [];
  selectedModules: any[] = [];
  selectedModule: string | null = null;

  onSelectionChange(event: any) {
    console.log('Selected Rows:', this.selectedRows);
  }
  constructor(
    private formBuilder: FormBuilder,
    private authService: AuthService,
    private utilityService: UtilityService,
    private apiservice: ActsearchService,
    private ReportAuthorizationService: ReportAuthorizationService
  ) { }
  ListReport: DropdownOption[] = [
    { value: 1, text: 'FSL' },
    { value: 2, text: 'Prosecution' },
    { value: 3, text: 'eSakshaya' },
    { value: 4, text: 'Medleapr' }
  ];


  UserType: DropdownOption[] = [
    { value: 1, text: 'Admin' },
    { value: 2, text: 'Normal' }
  ];

  ngOnInit(): void {
    this.form = this.formBuilder.group({
      searchType: ['state'],
      districtCodes: [null],
      modulename: [null],
      PsCodes: [null],
      Name: ['', [Validators.required, Validators.minLength(2)]],
      state: ['', Validators.required],
      ReportName: [[], Validators.required],
      userType: ['', Validators.required],
    });
    this.fg = this.formBuilder.group({
      districtCodes: [null],
      PsCodes: [null],
      state: ['', Validators.required],
      ReportName: [[], Validators.required],
      buttonType: [''],
      MobileNumber: [''],
    });

    this.BindDistricts();
    this.settings = {
      singleSelection: false,
      idField: 'value',
      textField: 'text',
      allowSearchFilter: true,
      maxHeight: 200
    };

    const stateCode = localStorage.getItem('stateCode') ?? '';

    this.authService.getStates().subscribe((data: any[]) => {
      this.states = data.filter(state => state.StateCode === stateCode);
    });
    this.form.get('Name')?.valueChanges.subscribe(val => {
      if (!val) {
        this.suggestions = [];
      }
    });

    this.form.get('searchType')?.valueChanges.subscribe(type => {
      this.updateValidators(type);
    });

    this.updateValidators(this.form.get('searchType')?.value);
  }
  updateValidators(searchType: string): void {
    this.form.get('state')?.setValidators(Validators.required);
    this.form.get('districtCodes')?.reset();
    this.form.get('PsCodes')?.reset();
    this.form.get('districtCodes')?.clearValidators();
    this.form.get('PsCodes')?.clearValidators();
    if (searchType === 'district') {
      this.form.get('districtCodes')?.setValidators(Validators.required);
    } else if (searchType === 'police') {
      this.form.get('districtCodes')?.setValidators(Validators.required);
      this.form.get('PsCodes')?.setValidators(Validators.required);
    }
    this.form.get('state')?.updateValueAndValidity();
    this.form.get('districtCodes')?.updateValueAndValidity();
    this.form.get('PsCodes')?.updateValueAndValidity();
  }

  get f(): { [key: string]: AbstractControl } {
    return this.form.controls;
  }

  onMobileInput(event: any): void {
    const input = event.target.value.replace(/[^0-9]/g, '');
    this.form.get('MobileNumber')?.setValue(input, { emitEvent: false });
  }

  onSubmit(): void {
    debugger;
    this.isSubmitted = true;
    const formData = this.form.value;
   
    const requestPayload = {
      Mobile: String(formData.Name?.MOBILE_1 ?? ''),
      State: formData.state,
      DistrictCodes: (formData.districtCodes || []).map((d: any) => +d.value),
      PsCodes: (formData.PsCodes || []).map((p: any) => +p.value),
      DistrictName: (formData.districtCodes || []).map((d: any) => d.text),
      PsName: (formData.PsCodes || []).map((p: any) => p.text),
      ReportNames: [],
      UserType: formData.userType,
      UserLevel: formData.searchType
    };

    this.ReportAuthorizationService.ModuleAssign(requestPayload).subscribe({
      next: (response) => {
        if (response.isSuccess) {
          Swal.fire({
            position: 'top-end',
            title: response.message,
            showConfirmButton: false,
            timer: 2000,
            customClass: {
              popup: 'custom-alert',
              title: 'custom-title',
            },
            background: '#006400',

          });
        } else {
          alert('Failed: ' + response.message);
        }
        this.loadModuleAssignData(String(formData.Name?.MOBILE_1));
      },
      error: (err) => {
        const errorMessage =
          err?.error?.message ||
          err?.message ||
          JSON.stringify(err);
      }
    });
  }
  BindDistricts(): void {
    this.apiservice.LoadDistricts().subscribe({
      next: (response) => {
        if (response.isSuccess && response.data && response.data.length > 0) {
          this.ListDistict = response.data;
          this.errorMessage = '';
        } else {
          this.errorMessage = 'No data available .';
          this.ListDistict = [];
        }
      },
      error: (err) => {
        this.errorMessage = 'Failed to load data from the server. Please try again later.';
        this.ListDistict = [];
      },
    });
  }
  onDistrictDropdownChange(event: any): void {
    debugger;
    const formValues = this.form.getRawValue();
    if (Array.isArray(formValues.districtCodes)) {
      const districtCodes = formValues.districtCodes.map((item: { value: any; }) => parseInt(item.value));
      this.ReportAuthorizationService.LoadPoliceStations(districtCodes).subscribe((data: any) => {
        if (data.isSuccess) {
          this.policestations = data.data;
        }
      });
    } else {
      console.error('districtCodes is not an array');
    }
  }

  onpolicestationsDropdownChange(event: any): void {
    if (this.form) {
      const formValues = this.form.getRawValue();
      if (Array.isArray(formValues.PsCds)) {
        const policestationsCodes = formValues.PsCds.map((item: { value: any; }) => parseInt(item.value));
      } else {
        console.error('PsCds is not an array');
      }
    } else {
      console.error('Form is not initialized');
    }
  }

  onModuleCheckboxChange(row: any, event?: any): void {
    this.fg.patchValue({
      districtCodes: row.DISTRICT_CD,
      PsCodes: row.PS_CD,
      state: row.STATE_CD,
      MobileNumber: row.MOBILE_NO
    });
    const isChecked = event ? event.target.checked : !this.isRowSelected(row);
    if (isChecked) {
      this.isModuleChecked = true;
      this.selectedModules = this.moduleAssignList.filter(x => x.moduleChecked);
    }
    else {
      this.isModuleChecked = false;
      this.selectedModules = [];
    }
  }
  readonly HIDDEN_COLUMNS = ['STATE_CD', 'DISTRICT_CD', 'PS_CD', 'BLOCK'];
  loadModuleAssignData($event: any): void {
    const formData = this.form.value;
    const mobileNumber = String(formData.Name?.MOBILE_1);
    this.Name = String(formData.Name?.FullName);

    this.ReportAuthorizationService.getModuleAssignList(mobileNumber).subscribe({
      next: (res) => {
        if (res.isSuccess) {
          this.moduleAssignList = res.data;
          console.log('Module Assign List:', this.moduleAssignList);

          if (this.moduleAssignList.length > 0) {
            const excludedColumns = ['STATE_CD', 'DISTRICT_CD', 'PS_CD', 'BLOCK'];

            this.moduleAssignColumns = Object.keys(this.moduleAssignList[0])
              .filter(key => !excludedColumns.includes(key))
              .map(key => ({
                field: key,
                header: this.formatHeader(key)
              }));
          }
        } else {
          this.moduleAssignList = [];
        }
      },
      error: (err) => {
        this.errorMessage = 'Failed to load module assignment data. Please try again later.';
        this.moduleAssignList = [];
      }
    });
  }


  formatHeader(key: string): string {
    return key.replace(/_/g, ' ')
      .replace(/([a-z])([A-Z])/g, '$1 $2')
      .toUpperCase();
  }


  getBrands($event: any) {
    this.authService.SearchByName($event.query).subscribe({
      next: (response: any) => {
        if (JSON.parse(response.data).length != 0) {
          const data = JSON.parse(response.data);
          console.log('Search Results:', data);
          const result = data.map((person: any) => ({
            MOBILE_1: person.MOBILE_1,
            FullName: person.FullName
          }));
          this.suggestions = Array.from(result);
        }
        else {
          this.suggestions = [];
        }
      }
    });
  }

  onSubmitSelected(): void {
    const psCodeArray: DropdownOption[] = this.form.controls["ReportName"].value || [];
    const textValues = psCodeArray.map(item => item.text);
    this.fg.patchValue({
      buttonType: 'Assign',
      ReportName: textValues
    });

    console.log('Selected Text Values:', textValues);
    console.log('Form Data:', this.fg.value);
    if (this.selectedRows && this.selectedRows.length > 0) {
      console.log('Submitting selected rows:', this.selectedRows);
    } else {
      console.warn('No rows selected.');
    }
  }

  onAssignModule(): void {
    const reportControl = this.form.get("ReportName");
    let reportNames = [];
    if (reportControl && reportControl.value) {
      const reportValue = Array.isArray(reportControl.value) ? reportControl.value : [reportControl.value];
      reportNames = reportValue.filter(item => item && (item.text || item.value)).map(item => item.text || String(item.value));
    }
    const formData = this.fg.value;
    const requestPayload = {
      stateCode: formData.state,
      districtCode: formData.districtCodes,
      psCode: formData.PsCodes,
      reportName: reportNames,
      buttonType: 'Assign',
      mobileNumber: String(formData.MobileNumber)
    };
    this.ReportAuthorizationService.UpdateModuleAssign(requestPayload).subscribe({
      next: (response: any) => {
        if (response.isSuccess) {
          Swal.fire({
            position: 'top-end',
            title: response.message,
            showConfirmButton: false,
            timer: 2000,
            customClass: {
              popup: 'custom-alert',
              title: 'custom-title',
            },
            background: '#006400',
          });
        } else {
          Swal.fire({
            position: 'center',
            title: 'Failed to Update Module Assignment',
            icon: 'error',
            showConfirmButton: true,
            background: '#fff3cd',
            color: '#000000',
          });
        }
        this.loadModuleAssignData(String(formData.MobileNumber));
      },
      error: (error) => {
        console.error('API Error:', error);
      }
    });
  }

  isAllSelected: boolean = false;

  onHeaderCheckboxToggle(event: any) {
    this.isAllSelected = event.checked;
    if (this.isAllSelected) {
      this.selectedRows = [...this.moduleAssignList];
      this.moduleAssignList.forEach(row => {
        if (!this.selectedRows.some(selected => selected.PS_CD === row.PS_CD)) {
          this.selectedRows.push(row);
        }
      });
    } else {
      this.selectedRows = [];
    }
  }

  isRowChecked(row: any): boolean {
    const isBlocked = row.BLOCK === true || row.BLOCK === 'true';
    return isBlocked || this.isRowSelected(row);
  }
  isRowSelected(row: any): boolean {
    return this.selectedRows.some(selected => selected.PS_CD === row.PS_CD);
  }
  getSelectedValues(): ModuleAssignUpdateRequestModel[] {
    debugger;
    return this.selectedRows.map(row => ({
      StateCode: row.STATE_CD,
      DistrictCode: row.DISTRICT_CD,
      PsCode: row.PS_CD,
      block: this.isRowSelected(row),
      ReportName: row['MODULE NAME']?.split(',') || [],
      MobileNumber: row.MOBILE_NO

    }));
  }

  submitSelectedModules() {
    const selectedData = this.getSelectedValues();
    if (selectedData.length === 0) {
      this.utilityService.ShowErrorPopup('Please select at least one row');
      return;
    }
    const mobileNumber = selectedData[0].MobileNumber;
    forkJoin(
      selectedData.map(data => this.ReportAuthorizationService.UpdateModuleAssign(data))
    ).subscribe({
      next: (responses) => {
        const allSuccess = responses.every(r => r.isSuccess);
        if (allSuccess) {
          Swal.fire({
            position: 'top-end',
            title: 'Record updated successfully.',
            showConfirmButton: false,
            timer: 2000,
            customClass: {
              popup: 'custom-alert',
              title: 'custom-title',
            },
            background: '#006400',
          });
          this.loadModuleAssignData(mobileNumber);
        } else {
          Swal.fire({
            position: 'center',
            title: 'Failed to Update Module Assignment',
            icon: 'error',
            showConfirmButton: true,
            background: '#fff3cd',
            color: '#000000',
          });
        }
      },
      error: (err) => {
        console.error('Error:', err);
        this.loadModuleAssignData(mobileNumber);
      }
    });
  }
  hasBlockedRows(): boolean {
    return this.moduleAssignList?.some(row => row.BLOCK) || false;
  }


}
